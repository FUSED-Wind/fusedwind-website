<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>fusedwind.runSuite.runBatch &mdash; FUSED-Wind  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootswatch-3.1.0/cerulean/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-3.1.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="FUSED-Wind  documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          FUSED-Wind</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../news.html">News</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../about_fusedwind.html">Software Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation.html">Source Documentation</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary">
<div class="">
<h3>Versions</h3>

<div class="list-group">
  <a href="https://github.com/FUSED-Wind/fusedwind" target="_blank" class="list-group-item">
    <h4 class="list-group-item-heading">Development</h4>
    <p class="list-group-item-text" href="https://github.com/FUSED-Wind/fusedwind">0.1.dev Github</p>
  </a>
  <a href="../../../installation.html" target="_blank" class="list-group-item">
    <h4 class="list-group-item-heading">Stable</h4>
    <p class="list-group-item-text" href="https://github.com/FUSED-Wind/fusedwind">Coming soon!</p>
  </a>
</div>

</div>


<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<h3>Contents</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../news.html">News</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../about_fusedwind.html">Software Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../documentation.html">Source Documentation</a></li>
</ul>

        </div>
      </div>
    <div class="col-md-9">
      
  <h1>Source code for fusedwind.runSuite.runBatch</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot; Here we will construct a cleaner version of openruniec.py.  It will simply read a table of run cases and run them. &quot;&quot;&quot;</span>


<span class="c"># main python driver to run wind load cases in a variety of ways, uses openMDAO</span>

<span class="kn">from</span> <span class="nn">openmdao.main.api</span> <span class="kn">import</span> <span class="n">Assembly</span><span class="p">,</span> <span class="n">Component</span>
<span class="kn">from</span> <span class="nn">openmdao.main.datatypes.slot</span> <span class="kn">import</span> <span class="n">Slot</span>
<span class="kn">from</span> <span class="nn">openmdao.lib.drivers.caseiterdriver</span> <span class="kn">import</span> <span class="n">CaseIteratorDriver</span>
<span class="kn">from</span> <span class="nn">openmdao.main.datatypes.api</span> <span class="kn">import</span> <span class="n">Int</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">types</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">openmdao.main.api</span> <span class="kn">import</span> <span class="n">Assembly</span><span class="p">,</span> <span class="n">Component</span><span class="p">,</span> <span class="n">FileMetadata</span>
<span class="kn">from</span> <span class="nn">openmdao.main.resource</span> <span class="kn">import</span> <span class="n">ResourceAllocationManager</span> <span class="k">as</span> <span class="n">RAM</span>
<span class="kn">from</span> <span class="nn">openmdao.lib.components.external_code</span> <span class="kn">import</span> <span class="n">ExternalCode</span>
<span class="kn">from</span> <span class="nn">openmdao.main.api</span> <span class="kn">import</span> <span class="n">Case</span><span class="p">,</span> <span class="n">Component</span>
<span class="c">#from openmdao.lib.drivers.api import ConnectableCaseIteratorDriver</span>
<span class="c">#from openmdao.lib.drivers.api import CaseIteratorDriver  ## brings in cobyla driver, which has bug on Peter&#39;s intel mac</span>
<span class="c">#from openmdao.lib.drivers.caseiterdriver import ConnectableCaseIteratorDriver</span>
<span class="kn">from</span> <span class="nn">openmdao.lib.drivers.caseiterdriver</span> <span class="kn">import</span> <span class="n">CaseIteratorDriver</span>

<span class="kn">from</span> <span class="nn">openmdao.lib.casehandlers.api</span> <span class="kn">import</span> <span class="n">ListCaseRecorder</span><span class="p">,</span> <span class="n">ListCaseIterator</span><span class="p">,</span> <span class="n">CSVCaseRecorder</span>
<span class="kn">from</span> <span class="nn">openmdao.lib.datatypes.api</span> <span class="kn">import</span> <span class="n">Str</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Bool</span><span class="p">,</span> <span class="n">Slot</span><span class="p">,</span> <span class="n">Instance</span>
<span class="kn">from</span> <span class="nn">openmdao.main.interfaces</span> <span class="kn">import</span> <span class="n">ICaseIterator</span>
<span class="kn">from</span> <span class="nn">openmdao.main.pbs</span> <span class="kn">import</span> <span class="n">PBS_Allocator</span> <span class="k">as</span> <span class="n">PBS</span>
<span class="kn">from</span> <span class="nn">openmdao.main.resource</span> <span class="kn">import</span> <span class="n">ResourceAllocationManager</span> <span class="k">as</span> <span class="n">RAM</span>
<span class="kn">from</span> <span class="nn">openmdao.util.testutil</span> <span class="kn">import</span> <span class="n">find_python</span>



<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="c">#from openmdao.main.api import enable_console</span>
<span class="c">#enable_console()</span>

<span class="c"># run case stuff</span>
<span class="c"># run case stuff</span>
<span class="kn">from</span> <span class="nn">fusedwind.runSuite.runCase</span> <span class="kn">import</span> <span class="n">GenericRunCaseTable</span>
<span class="c">#from runCase import GenericRunCaseTable</span>
<span class="c">### bug in openmdao somewhere: using &quot;from runCase import GenericRunCaseTable&quot; (instead of &quot;full dotted path&quot;) gives error in ~&quot;instance.validate&quot; (within</span>
<span class="c">### openmdao) concerning GenericRunCase vs runcase.GenericRunCase (not the same).  no idea really why.</span>
<span class="kn">from</span> <span class="nn">fusedwind.lib.base</span> <span class="kn">import</span> <span class="n">FUSEDAssembly</span>
<span class="kn">from</span> <span class="nn">fusedwind.runSuite.runCase</span> <span class="kn">import</span> <span class="n">IECRunCaseBaseVT</span><span class="p">,</span> <span class="n">IECOutputsBaseVT</span>
<span class="kn">from</span> <span class="nn">fusedwind.runSuite.runAero</span> <span class="kn">import</span> <span class="n">FUSEDIECBase</span><span class="p">,</span> <span class="n">openAeroCode</span><span class="p">,</span> <span class="n">PGrafObject</span>
<span class="c">#from fusedwind.runSuite.runAero import FUSEDIECBase</span>

<span class="kn">from</span> <span class="nn">fusedwind.runSuite.runCase</span> <span class="kn">import</span> <span class="n">GenericRunCase</span>

<span class="c">#from runAero import PGrafObject</span>


<div class="viewcode-block" id="PostprocessIECCasesBase"><a class="viewcode-back" href="../../../runbatch_ex.html#fusedwind.runSuite.runBatch.PostprocessIECCasesBase">[docs]</a><span class="k">class</span> <span class="nc">PostprocessIECCasesBase</span><span class="p">(</span><span class="n">Component</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Postprocess list of cases returned by a case recorder</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cases</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">(</span><span class="n">ICaseIterator</span><span class="p">,</span> <span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">)</span>
    <span class="n">keep_dirs</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;Flag to keep ObjServer directories for debugging purposes&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cases</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="s">&#39;runner.inputs&#39;</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&#39;processing case </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">inputs</span><span class="o">.</span><span class="n">case_name</span>

<span class="c"># frza: can&#39;t get the inheritance from FUSEDCaseIterator to work, so commented for now</span>
<span class="c"># class FUSEDIECCaseIterator(FUSEDCaseIterator):</span>

<span class="c">#     def configure(self):</span>

<span class="c">#         super(FUSEDIECCaseIterator, self).configure()</span>
<span class="c">#         # self.replace(&#39;inputs&#39;, IECRunCaseBaseVT())</span>
<span class="c">#         # self.replace(&#39;outputs&#39;, IECOutputsBaseVT())</span>
<span class="c">#         self.replace(&#39;runner&#39;, FUSEDIECBase())</span>

        <span class="c"># self.replace()</span>

</div>
<div class="viewcode-block" id="FUSEDIECCaseIterator"><a class="viewcode-back" href="../../../runbatch_ex.html#fusedwind.runSuite.runBatch.FUSEDIECCaseIterator">[docs]</a><span class="k">class</span> <span class="nc">FUSEDIECCaseIterator</span><span class="p">(</span><span class="n">FUSEDAssembly</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; main driver of whole show, after input is read  wraps an openmdao CaseIteratorDriver,</span>
<span class="sd">    which has an openAeroCode assembly in its workflow, and whose cases are perhaps</span>
<span class="sd">    aero-code specific Case() objects that are sent into the aerocode via a slot variable</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cases</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s">&#39;List of cases to run&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="FUSEDIECCaseIterator.configure"><a class="viewcode-back" href="../../../runbatch_ex.html#fusedwind.runSuite.runBatch.FUSEDIECCaseIterator.configure">[docs]</a>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Configures an assembly for running with the CaseIteratorDriver&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;configuring dispatcher&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;case_driver&#39;</span><span class="p">,</span> <span class="n">ConnectableCaseIteratorDriver</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="s">&#39;case_driver&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;runner&#39;</span><span class="p">,</span> <span class="n">FUSEDIECBase</span><span class="p">())</span>
<span class="c">#        self.add(&#39;runner&#39;, openAeroCode())</span>
<span class="c">#       self.add(&#39;runner&#39;, FUSEDAssembly())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">case_driver</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;runner&#39;</span><span class="p">)</span>

        <span class="c"># Boolean for running sequentially or in parallel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_passthrough</span><span class="p">(</span><span class="s">&#39;case_driver.sequential&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">case_driver</span><span class="o">.</span><span class="n">recorders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ListCaseRecorder</span><span class="p">())</span>

        <span class="c"># component for postprocessing results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;post&#39;</span><span class="p">,</span> <span class="n">PostprocessIECCasesBase</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;post&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;case_driver.evaluated&#39;</span><span class="p">,</span> <span class="s">&#39;post.cases&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;dispatcher configured&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FUSEDIECCaseIterator.setup_cases"><a class="viewcode-back" href="../../../runbatch_ex.html#fusedwind.runSuite.runBatch.FUSEDIECCaseIterator.setup_cases">[docs]</a>    <span class="k">def</span> <span class="nf">setup_cases</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        setup the cases to run</span>

<span class="sd">        This method has to be called after instantiation of the class, once the ``cases``</span>
<span class="sd">        list has been set.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">runcases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cases</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Adding case </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span> <span class="n">case</span><span class="o">.</span><span class="n">case_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runcases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Case</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span> <span class="p">[(</span><span class="s">&#39;runner.inputs&#39;</span><span class="p">,</span> <span class="n">case</span><span class="p">)],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;runner.outputs&#39;</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">case_driver</span><span class="o">.</span><span class="n">iterator</span> <span class="o">=</span> <span class="n">ListCaseIterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runcases</span><span class="p">)</span>


<span class="c">################# from openmdao &quot;test&quot; code</span>




</div></div>
<span class="k">class</span> <span class="nc">PGrafComponent</span><span class="p">(</span><span class="n">Assembly</span><span class="p">):</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;in&#39;</span><span class="p">)</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">Slot</span><span class="p">(</span><span class="n">PGrafObject</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="n">iotype</span><span class="o">=</span><span class="s">&#39;out&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;comp execute&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">num</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">num</span>


<span class="k">class</span> <span class="nc">PGrafSubComponent</span><span class="p">(</span><span class="n">PGrafComponent</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;subcomp execute&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">num</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">num</span>


<span class="k">class</span> <span class="nc">PGrafAssembly</span><span class="p">(</span><span class="n">Assembly</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;driver&#39;</span><span class="p">,</span> <span class="n">CaseIteratorDriver</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;runner&#39;</span><span class="p">,</span> <span class="n">PGrafSubComponent</span><span class="p">())</span>
        <span class="n">cid</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;runner&#39;</span><span class="p">)</span>
        <span class="n">cid</span><span class="o">.</span><span class="n">sequential</span> <span class="o">=</span> <span class="bp">True</span> <span class="c">#False</span>
        <span class="c"># uncomment to keep simulation directories for debugging purposes</span>
        <span class="c">#import os</span>
        <span class="c">#os.environ[&#39;OPENMDAO_KEEPDIRS&#39;] = &#39;1&#39;</span>

        <span class="n">cid</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s">&#39;runner.inputs&#39;</span><span class="p">)</span>
        <span class="n">cid</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s">&#39;runner.num&#39;</span><span class="p">)</span>
        <span class="n">cid</span><span class="o">.</span><span class="n">add_response</span><span class="p">(</span><span class="s">&#39;runner.result&#39;</span><span class="p">)</span>

        <span class="n">cid</span><span class="o">.</span><span class="n">case_inputs</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">PGrafObject</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
        <span class="n">cid</span><span class="o">.</span><span class="n">case_inputs</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">num</span> <span class="o">=</span> <span class="p">[</span><span class="n">num</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>



<span class="c">##########################################</span>


<span class="c">## orchestrate process with CaseIteratorDriver</span>
<div class="viewcode-block" id="CaseAnalyzer"><a class="viewcode-back" href="../../../runbatch_ex.html#fusedwind.runSuite.runBatch.CaseAnalyzer">[docs]</a><span class="k">class</span> <span class="nc">CaseAnalyzer</span><span class="p">(</span><span class="n">Assembly</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; main driver of whole show, after input is read  wraps an openmdao CaseIteratorDriver,</span>
<span class="sd">    which has an openAeroCode assembly in its workflow, and whose cases are perhaps</span>
<span class="sd">    aero-code specific Case() objects that are sent into the aerocode via a slot variable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CaseAnalyzer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_parallel</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">openmdao_version</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;parallel&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_parallel</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;parallel&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">presetup_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aerocode</span><span class="p">,</span> <span class="n">cases</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aerocode</span> <span class="o">=</span> <span class="n">aerocode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">studycases</span> <span class="o">=</span> <span class="n">cases</span>

    <span class="k">def</span> <span class="nf">configure_old</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;configuring dispatcher:&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CaseAnalyzer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>

        <span class="n">driver</span> <span class="o">=</span> <span class="n">CaseIteratorDriver</span><span class="p">()</span>
<span class="c">#        driver = ConnectableCaseIteratorDriver()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;ws_driver&#39;</span><span class="p">,</span> <span class="n">driver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">add</span><span class="p">([</span><span class="s">&#39;ws_driver&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;runner&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aerocode</span> <span class="p">)</span>
<span class="c">#        self.add(&#39;runner&#39;, MyCode() )   # for testing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws_driver</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;runner&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup_cases</span><span class="p">()</span>

        <span class="c"># comment this line out to run sequentially</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws_driver</span><span class="o">.</span><span class="n">sequential</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_parallel</span>
        <span class="c"># uncomment to keep simulation directories for debugging purposes</span>
<span class="c">#        os.environ[&#39;OPENMDAO_KEEPDIRS&#39;] = &#39;1&#39;</span>
        <span class="c"># apparently a workaround for an openmdao bug:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws_driver</span><span class="o">.</span><span class="n">ignore_egg_requirements</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">print</span> <span class="s">&quot;dispatcher configured</span><span class="se">\n</span><span class="s">-------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span>


    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">False</span><span class="p">:</span>  <span class="c">## testing</span>
            <span class="n">cid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;driver&#39;</span><span class="p">,</span> <span class="n">CaseIteratorDriver</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;runner&#39;</span><span class="p">,</span> <span class="n">PGrafSubComponent</span><span class="p">())</span>
            <span class="n">cid</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;runner&#39;</span><span class="p">)</span>
            <span class="n">cid</span><span class="o">.</span><span class="n">sequential</span> <span class="o">=</span> <span class="bp">True</span> <span class="c">#False</span>
            <span class="c"># uncomment to keep simulation directories for debugging purposes</span>
            <span class="c">#import os</span>
            <span class="c">#os.environ[&#39;OPENMDAO_KEEPDIRS&#39;] = &#39;1&#39;</span>

            <span class="n">cid</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s">&#39;runner.inputs&#39;</span><span class="p">)</span>

            <span class="n">cid</span><span class="o">.</span><span class="n">case_inputs</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">PGrafObject</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
    
        <span class="k">if</span> <span class="bp">True</span><span class="p">:</span>  <span class="c">## real thing</span>
            <span class="k">print</span> <span class="s">&quot;configuring dispatcher:&quot;</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">CaseAnalyzer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>

            <span class="n">cid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;driver&#39;</span><span class="p">,</span> <span class="n">CaseIteratorDriver</span><span class="p">())</span>
<span class="c">#            self.add(&#39;runner&#39;, PGrafSubComponent())</span>
<span class="c">#            print self.aerocode</span>
<span class="c">#            self.add(&#39;runner&#39;, openAeroCode())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;runner&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aerocode</span> <span class="p">)</span>
            <span class="n">cid</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;runner&#39;</span><span class="p">)</span>
<span class="c">#            cid.sequential = True #False</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">setup_cases</span><span class="p">()</span>

            <span class="c"># comment this line out to run sequentially</span>
            <span class="n">cid</span><span class="o">.</span><span class="n">sequential</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_parallel</span>
            <span class="c"># uncomment to keep simulation directories for debugging purposes</span>
    <span class="c">#        os.environ[&#39;OPENMDAO_KEEPDIRS&#39;] = &#39;1&#39;</span>

            <span class="c"># apparently a workaround for an openmdao bug:</span>
            <span class="n">cid</span><span class="o">.</span><span class="n">ignore_egg_requirements</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openmdao_version</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">):</span>
                <span class="n">cid</span><span class="o">.</span><span class="n">iterator</span> <span class="o">=</span> <span class="n">ListCaseIterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runcases</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cid</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="s">&#39;runner.inputs&#39;</span><span class="p">)</span>
   <span class="c">#            cid.case_inputs.runner.inputs = [PGrafObject(num) for num in range(4)]</span>
   <span class="c">#            cid.case_inputs.runner.inputs = [GenericRunCase(&quot;acase&quot;, [&#39;x&#39;,&#39;y&#39;], [num, num*2]) for num in range(4)]</span>
                <span class="n">cid</span><span class="o">.</span><span class="n">case_inputs</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">studycases</span>
    

        <span class="k">print</span> <span class="s">&quot;dispatcher configured</span><span class="se">\n</span><span class="s">-------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span>

<div class="viewcode-block" id="CaseAnalyzer.setup_cases"><a class="viewcode-back" href="../../../runbatch_ex.html#fusedwind.runSuite.runBatch.CaseAnalyzer.setup_cases">[docs]</a>    <span class="k">def</span> <span class="nf">setup_cases</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; setup the cases &quot;&quot;&quot;</span>
<span class="c"># openmdao through v0.9.5 at least, breaks at 0.1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runcases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">run_case_builder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aerocode</span><span class="o">.</span><span class="n">getRunCaseBuilder</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dlc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">studycases</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runcases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Case</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span> <span class="p">[(</span><span class="s">&#39;runner.inputs&#39;</span><span class="p">,</span> <span class="n">dlc</span><span class="p">)]))</span>
            <span class="k">print</span> <span class="s">&quot;building dlc for: &quot;</span><span class="p">,</span> <span class="n">dlc</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">dlc</span><span class="o">.</span><span class="n">name</span>
<span class="c">## even older:</span>
<span class="c">##            runcase = run_case_builder.buildRunCase_x(dlc.x, dlc.param_names, dlc)</span>
<span class="c">##            self.runcases.append(Case(inputs= [(&#39;runner.input&#39;, runcase)]))</span>
<span class="c">##</span>

<span class="c"># 0.1.0 and beyond</span>
<span class="c">#        print &quot;study cases&quot;</span>
<span class="c">#        for dlc in self.studycases:</span>
<span class="c">#            print dlc</span>
<span class="c">#        self.ws_driver.case_inputs.runner.inputs = self.studycases</span>
<span class="c">#        self.ws_driver.case_inputs.runner.inputs = [PGrafObject(num) for num in range(4)]</span>
<span class="c">#        print &quot;set up the cases, good luck!&quot;</span>


        <span class="c"># note NO output; collecting it by hand from file system</span>
</div>
    <span class="k">def</span> <span class="nf">collect_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_params</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;RUNS ARE DONE:&quot;</span>
        <span class="k">print</span> <span class="s">&quot;collecting output from copied-back files (not from case recorder), see </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">output_params</span><span class="p">[</span><span class="s">&#39;main_output_file&#39;</span><span class="p">]</span>
        <span class="n">fout</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">output_params</span><span class="p">[</span><span class="s">&#39;main_output_file&#39;</span><span class="p">],</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">fres</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="s">&quot;failed_cases.txt&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">acase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runcases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_inputs</span><span class="p">[</span><span class="s">&#39;runner.inputs&#39;</span><span class="p">]</span> <span class="c">## any easier way to get this back?</span>
        <span class="k">print</span> <span class="s">&quot;processing case&quot;</span><span class="p">,</span> <span class="n">acase</span>
        <span class="n">parms</span> <span class="o">=</span> <span class="n">acase</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parms</span><span class="p">:</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">fres</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;   &quot;</span><span class="p">)</span>
        <span class="n">fres</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;   &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&quot;output_operations&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output_params</span><span class="p">:</span>
            <span class="n">output_ops</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;max&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_ops</span> <span class="o">=</span> <span class="n">output_params</span><span class="p">[</span><span class="s">&#39;output_operations&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_ops</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">StringTypes</span><span class="p">):</span>  <span class="c">## hack to adjust if we actually did not get a list</span>
                <span class="n">output_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">output_ops</span><span class="p">]</span>
        <span class="n">outnames</span> <span class="o">=</span> <span class="n">output_params</span><span class="p">[</span><span class="s">&#39;output_keys&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">output_ops</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="s">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">op</span><span class="p">):</span>
                <span class="n">op</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">outnames</span><span class="p">:</span>
                <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fullcase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">runcases</span><span class="p">:</span>
            <span class="n">case</span> <span class="o">=</span> <span class="n">fullcase</span><span class="o">.</span><span class="n">_inputs</span><span class="p">[</span><span class="s">&#39;runner.inputs&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parms</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">sample</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.16e</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;   &quot;</span><span class="p">)</span>
            <span class="n">results_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aerocode</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="n">case</span><span class="o">.</span><span class="n">case_name</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;collecting from &quot;</span><span class="p">,</span> <span class="n">results_dir</span>
            <span class="k">for</span> <span class="n">opstr</span> <span class="ow">in</span> <span class="n">output_ops</span><span class="p">:</span>                
                <span class="c">## we have a system where the function we do the postprocessing with can be specified in the control</span>
                <span class="c">## input file via: &quot;output_operations&quot; tag.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">opstr</span><span class="p">):</span>
                        <span class="n">mod</span> <span class="o">=</span> <span class="n">opstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">opstr2</span> <span class="o">=</span> <span class="n">opstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">op</span> <span class="o">=</span><span class="nb">getattr</span><span class="p">(</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span> <span class="p">[</span><span class="n">opstr2</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">opstr2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">op</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">opstr</span><span class="p">)</span>  <span class="c">## this gives us the &quot;python function object&quot; described by opstr (e.g. string &quot;np.std&quot;  something we can call)</span>
                   <span class="c"># op is called  as op(col):R^n -&gt; R. i.e. gets passed an array (output vs time) and produces a scalar.</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;ERROR: Failed to find use specified postprocessing function &quot;</span><span class="p">,</span> <span class="n">opstr</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aerocode</span><span class="o">.</span><span class="n">getResults</span><span class="p">(</span><span class="n">output_params</span><span class="p">[</span><span class="s">&#39;output_keys&#39;</span><span class="p">],</span> <span class="n">results_dir</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="n">op</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="bp">None</span><span class="p">):</span>
                            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;nan &quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.16e</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;DIRECTORY FAILED: &quot;</span><span class="p">,</span> <span class="n">results_dir</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parms</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">sample</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                        <span class="n">fres</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.16e</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>
                    <span class="n">fres</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&quot;   </span><span class="si">%s</span><span class="s"> </span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">results_dir</span><span class="p">))</span>
                    <span class="k">break</span>   <span class="c"># breaks out of &quot;for opstr ...&quot; so we don&#39;t repeat this message</span>

            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">fres</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c">########### </span>
<span class="c">## rest of code is options handling, input file handling.  Maybe generic enough for fusedwind.</span>
</div>
<span class="k">def</span> <span class="nf">get_options</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">()</span>    
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-i&quot;</span><span class="p">,</span> <span class="s">&quot;--input&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;main_input&quot;</span><span class="p">,</span>  <span class="nb">type</span><span class="o">=</span><span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&quot;runbatch-cases.txt&quot;</span><span class="p">,</span>
                                    <span class="n">help</span><span class="o">=</span><span class="s">&quot;main input file describing cases to run&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-f&quot;</span><span class="p">,</span> <span class="s">&quot;--files&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;file_locs&quot;</span><span class="p">,</span>  <span class="nb">type</span><span class="o">=</span><span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&quot;runbatch-control.txt&quot;</span><span class="p">,</span>
                                    <span class="n">help</span><span class="o">=</span><span class="s">&quot;main input file describing locations of template files, and output fields/files to write&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-p&quot;</span><span class="p">,</span> <span class="s">&quot;--parallel&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;run_parallel&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;run in parallel&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;--cluster&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;cluster_allocator&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;run using cluster allocator&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-n&quot;</span><span class="p">,</span> <span class="s">&quot;--norun&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;norun&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;just process results&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-s&quot;</span><span class="p">,</span> <span class="s">&quot;--start_at&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;start_at&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;index of sample to start at&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">options</span><span class="p">,</span> <span class="n">args</span>

<span class="k">def</span> <span class="nf">read_file_string</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
    <span class="n">lns</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">lns</span><span class="p">:</span>
        <span class="n">ln</span> <span class="o">=</span> <span class="n">ln</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ln</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="ow">or</span> <span class="n">ln</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;#&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ln</span> <span class="o">=</span> <span class="n">ln</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ln</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="n">tag</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">ln</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&#39;</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">val</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">read_file_string_list</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
    <span class="n">ln</span> <span class="o">=</span> <span class="n">read_file_string</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ln</span> <span class="o">==</span> <span class="bp">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s">&quot;key </span><span class="si">%s</span><span class="s"> not found in </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">ln</span> <span class="o">=</span> <span class="n">ln</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">ln</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c"># it&#39;s not a list, so just return the value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">val</span>  <span class="c"># otherwise we want the list</span>

<div class="viewcode-block" id="parse_key_val_file_all"><a class="viewcode-back" href="../../../runbatch_ex.html#fusedwind.runSuite.runBatch.parse_key_val_file_all">[docs]</a><span class="k">def</span> <span class="nf">parse_key_val_file_all</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; parse key/value file, some entries might be _lists_ of strings &quot;&quot;&quot;</span>

    <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">lns</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">lns</span><span class="p">:</span>
        <span class="n">ln</span> <span class="o">=</span> <span class="n">ln</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ln</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span> <span class="ow">and</span> <span class="n">ln</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;#&quot;</span><span class="p">:</span>
            <span class="n">ln</span> <span class="o">=</span> <span class="n">ln</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">ln</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">ln</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;#&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&#39;</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="n">val2</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">output</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&#39;</span><span class="s">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">output</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

<span class="c">#    output[&#39;main_output_file&#39;] = read_file_string(&quot;main_output_file&quot;, fname)</span>
<span class="c">#    output[&#39;output_keys&#39;] = read_file_string_list(&quot;output_keys&quot;, fname)</span>
<span class="c">#    output[&#39;output_operations&#39;] = read_file_string_list(&quot;output_operations&quot;, fname)</span>

    <span class="k">return</span> <span class="n">output</span>


<span class="c">##### dealing with input(?) --- probably overkill</span></div>
<div class="viewcode-block" id="RunControlInput"><a class="viewcode-back" href="../../../runbatch_ex.html#fusedwind.runSuite.runBatch.RunControlInput">[docs]</a><span class="k">class</span> <span class="nc">RunControlInput</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; class to modularize the input&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c">## For now assume these are all just dictionaries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cases</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aerocode</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatcher</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>

</div>
<div class="viewcode-block" id="parse_input"><a class="viewcode-back" href="../../../runbatch_ex.html#fusedwind.runSuite.runBatch.parse_input">[docs]</a><span class="k">def</span> <span class="nf">parse_input</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; input comes in a lot of categories, roughly broken into:</span>
<span class="sd">    -- the turbine to simulate (formerly a FAST template file)</span>
<span class="sd">    -- the design load cases to simulate</span>
<span class="sd">    -- the wind code to use</span>
<span class="sd">    -- the manner in which to simulate them</span>
<span class="sd">    -- where to find the inputs and </span>
<span class="sd">    -- what to put in the outputs</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ctrl</span> <span class="o">=</span> <span class="n">RunControlInput</span><span class="p">()</span>
    <span class="n">ctrl</span><span class="o">.</span><span class="n">cases</span><span class="p">[</span><span class="s">&#39;source_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">main_input</span>        

    <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">run_parallel</span><span class="p">):</span>
        <span class="c">## turns on openmdao concurrent execution stuff</span>
        <span class="k">print</span> <span class="s">&quot;parallel run&quot;</span>
        <span class="n">ctrl</span><span class="o">.</span><span class="n">dispatcher</span><span class="p">[</span><span class="s">&#39;parallel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c">## input is raw cases</span>

    <span class="c"># read file locations</span>
    <span class="n">ctrl</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">parse_key_val_file_all</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">file_locs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ctrl</span>



<span class="c">#### below here can all be considered &quot;testing code&quot; now.  Driver app we really use is assembled in custom way from above parts (and others).</span>
<span class="c"># See AeroelasticSE/iecApp.py</span>
<span class="c">####</span>

<span class="c">###########################################################################</span>
<span class="c">### &quot;Factories&quot; for making the appropriate objects, given the input. This is inevitable and</span>
<span class="c">### separated out here.</span></div>
<span class="k">def</span> <span class="nf">create_run_cases</span><span class="p">(</span><span class="n">case_params</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">GenericRunCaseTable</span><span class="p">()</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">initFromFile</span><span class="p">(</span><span class="n">case_params</span><span class="p">[</span><span class="s">&#39;source_file&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">start_at</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">start_at</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">cases</span>

<div class="viewcode-block" id="create_turbine"><a class="viewcode-back" href="../../../runbatch_ex.html#fusedwind.runSuite.runBatch.create_turbine">[docs]</a><span class="k">def</span> <span class="nf">create_turbine</span><span class="p">(</span><span class="n">turbine_params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; create turbine object &quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">t</span>
</div>
<div class="viewcode-block" id="create_aerocode_wrapper"><a class="viewcode-back" href="../../../runbatch_ex.html#fusedwind.runSuite.runBatch.create_aerocode_wrapper">[docs]</a><span class="k">def</span> <span class="nf">create_aerocode_wrapper</span><span class="p">(</span><span class="n">aerocode_params</span><span class="p">,</span> <span class="n">output_params</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; create  wind code wrapper&quot;&quot;&quot;</span>

    <span class="n">solver</span> <span class="o">=</span> <span class="s">&#39;FAST&#39;</span>
<span class="c">#    solver = &#39;HAWC2&#39;</span>

    <span class="k">if</span> <span class="n">solver</span><span class="o">==</span><span class="s">&#39;FAST&#39;</span><span class="p">:</span>
        <span class="c">## TODO, changed when we have a real turbine</span>
        <span class="c"># aero code stuff: for constructors</span>
        <span class="kn">from</span> <span class="nn">AeroelasticSE.FusedFAST</span> <span class="kn">import</span> <span class="n">openFAST</span> 
        <span class="n">w</span> <span class="o">=</span> <span class="n">openFAST</span><span class="p">(</span><span class="n">output_params</span><span class="p">)</span>  <span class="c">## need better name than output_params</span>
<span class="c">#        w = openFAST(None, atm, output_params)  ## need better name than output_params</span>
        <span class="n">w</span><span class="o">.</span><span class="n">setOutput</span><span class="p">(</span><span class="n">output_params</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">solver</span> <span class="o">==</span> <span class="s">&#39;HAWC2&#39;</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">openHAWC2</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">,</span> <span class="s">&quot;HAWC2 aeroecode wrapper not implemented in runBatch.py yet&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s">&quot;unknown aerocode: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">solver</span>
    <span class="k">return</span> <span class="n">w</span>

<span class="c"># dispatcher is a little more generic, for far only one of them. will _use_ different true</span>
<span class="c"># dispatchers, i.e. parallel interfaces to different systems.</span></div>
<div class="viewcode-block" id="create_dlc_dispatcher"><a class="viewcode-back" href="../../../runbatch_ex.html#fusedwind.runSuite.runBatch.create_dlc_dispatcher">[docs]</a><span class="k">def</span> <span class="nf">create_dlc_dispatcher</span><span class="p">(</span><span class="n">dispatch_params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; create dispatcher</span>
<span class="sd">    dispatcher originally meant to signify role as handling _how_ the computations are done</span>
<span class="sd">    E.g., we could have a parallel dispatcher, etc. For now this just handled by a flag, all the work is done</span>
<span class="sd">    in openmdao, ie ## so far there is actually only one type of dispatcher. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">CaseAnalyzer</span><span class="p">(</span><span class="n">dispatch_params</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span>
<span class="c">##</span>
<span class="c">###########################################</span>
</div>
<span class="k">def</span> <span class="nf">rf</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
    <span class="c">## mv this and</span>
    <span class="kn">from</span> <span class="nn">rainflow</span> <span class="kn">import</span> <span class="n">rain_one</span>
    <span class="c"># wrapper for rainflow algorithm</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">rain_one</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">val</span>

<span class="c">## main function that opens input, runs cases, writes output, ie. whole thing.</span>
<div class="viewcode-block" id="rundlcs"><a class="viewcode-back" href="../../../runbatch_ex.html#fusedwind.runSuite.runBatch.rundlcs">[docs]</a><span class="k">def</span> <span class="nf">rundlcs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    run the whole process, including startup and shutdown</span>
<span class="sd">    to do:</span>
<span class="sd">    parse input</span>
<span class="sd">    create load cases</span>
<span class="sd">    create app assembly</span>
<span class="sd">    create dispatcher</span>
<span class="sd">    send cases and app to dispatcher</span>
<span class="sd">    run cases</span>
<span class="sd">    collect and save output</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">options</span><span class="p">,</span> <span class="n">arg</span> <span class="o">=</span> <span class="n">get_options</span><span class="p">()</span>
    <span class="n">ctrl</span> <span class="o">=</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="c"># ctrl will be just the input, but broken up into separate categories, e.g.</span>
    <span class="c"># ctrl.cases, ctrl.app, ctrl.dispatch, ...</span>

    <span class="c"># work in progress; running efficiently at NREL.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">cluster_allocator</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">PeregrineClusterAllocator</span> <span class="kn">import</span> <span class="n">ClusterAllocator</span>
        <span class="n">cluster</span><span class="o">=</span><span class="n">ClusterAllocator</span><span class="p">()</span>
        <span class="n">RAM</span><span class="o">.</span><span class="n">insert_allocator</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">cluster</span><span class="p">)</span>

    <span class="c">###  using &quot;factory&quot; functions to create specific subclasses (e.g. distinguish between FAST and HAWC2)</span>
    <span class="c"># Then we use these to create the cases...</span>
    <span class="n">cases</span> <span class="o">=</span> <span class="n">create_run_cases</span><span class="p">(</span><span class="n">ctrl</span><span class="o">.</span><span class="n">cases</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
    <span class="c"># and a turbine---never used this &quot;stub&quot;</span>
<span class="c">#    turbine = create_turbine(ctrl.turbine)</span>
    <span class="c"># and the appropriate wind code wrapper...</span>
    <span class="n">aerocode</span> <span class="o">=</span> <span class="n">create_aerocode_wrapper</span><span class="p">(</span><span class="n">ctrl</span><span class="o">.</span><span class="n">aerocode</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
    <span class="c"># and the appropriate dispatcher...</span>
    <span class="n">dispatcher</span> <span class="o">=</span> <span class="n">create_dlc_dispatcher</span><span class="p">(</span><span class="n">ctrl</span><span class="o">.</span><span class="n">dispatcher</span><span class="p">)</span>
    <span class="c">### After this point everything should be generic, all appropriate subclass object created</span>
    <span class="c"># # # # # # # # # # #</span>

    <span class="n">dispatcher</span><span class="o">.</span><span class="n">presetup_workflow</span><span class="p">(</span><span class="n">aerocode</span><span class="p">,</span> <span class="n">cases</span><span class="p">)</span>  <span class="c"># just makes sure parts are there when configure() is called</span>
    <span class="n">dispatcher</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>
    <span class="c"># Now tell the dispatcher to (setup and ) run the cases using the aerocode on the turbine.</span>
    <span class="c"># calling configure() is done inside run(). but now it is done already (above), too.</span>

    <span class="c"># norun does not write directories, but it does set us up to process them if they already exist</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">norun</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;calling run&quot;</span>
        <span class="n">dispatcher</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c"># TODO:  more complexity will be needed for difference between &quot;run now&quot; and &quot;run later&quot; cases.</span>
    <span class="n">dispatcher</span><span class="o">.</span><span class="n">collect_output</span><span class="p">(</span><span class="n">ctrl</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>


</div>
<span class="k">def</span> <span class="nf">nexttest</span><span class="p">():</span>
    <span class="n">options</span><span class="p">,</span> <span class="n">arg</span> <span class="o">=</span> <span class="n">get_options</span><span class="p">()</span>
    <span class="n">ctrl</span> <span class="o">=</span> <span class="n">parse_input</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="n">cases</span> <span class="o">=</span> <span class="n">create_run_cases</span><span class="p">(</span><span class="n">ctrl</span><span class="o">.</span><span class="n">cases</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
    <span class="n">aerocode</span> <span class="o">=</span> <span class="n">create_aerocode_wrapper</span><span class="p">(</span><span class="n">ctrl</span><span class="o">.</span><span class="n">aerocode</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
    <span class="n">dispatcher</span> <span class="o">=</span> <span class="n">create_dlc_dispatcher</span><span class="p">(</span><span class="n">ctrl</span><span class="o">.</span><span class="n">dispatcher</span><span class="p">)</span>
    <span class="n">dispatcher</span><span class="o">.</span><span class="n">presetup_workflow</span><span class="p">(</span><span class="n">aerocode</span><span class="p">,</span> <span class="n">cases</span><span class="p">)</span>  <span class="c"># just makes sure parts are there when configu    print &quot;calling run&quot;</span>
    <span class="n">dispatcher</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">basetest</span><span class="p">():</span>
    <span class="n">top</span> <span class="o">=</span> <span class="n">CaseAnalyzer</span><span class="p">({})</span>
<span class="c">#    top = PGrafAssembly()</span>
    <span class="n">top</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">&quot;__main__&quot;</span><span class="p">:</span>
<span class="c">#    rundlcs()</span>
<span class="c">#    basetest()</span>
    <span class="n">nexttest</span><span class="p">()</span>
</pre></div>

    </div>
      
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.2.<br/>
    </p>
  </div>
</footer>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-40451380-2', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>